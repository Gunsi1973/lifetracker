<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>LifeTracker - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-light">

    <div class="container-fluid py-4">
        <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom bg-white p-3 rounded shadow-sm">
            <h1 class="h3 mb-0">LifeTracker Timeline</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-primary shadow" data-bs-toggle="modal" data-bs-target="#eventModal">+ Event</button>
                <button class="btn btn-outline-secondary shadow" data-bs-toggle="modal" data-bs-target="#personModal">+ Person</button>
                <button onclick="loadTimeline()" class="btn btn-light border shadow">üîÑ Refresh</button>
            </div>
        </header>

        <div class="card shadow-sm mb-4 border-0 bg-white">
            <div class="card-body py-2 px-3">
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><span class="badge bg-dark">FILTER</span></div>
                    <div class="col-md-3">
                        <select id="filterCategory" class="form-select form-select-sm" onchange="applyFilters()">
                            <option value="all">Alle Kategorien</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch pt-1">
                            <input class="form-check-input" type="checkbox" id="filterPrivate" onchange="applyFilters()" checked>
                            <label class="form-check-label small" for="filterPrivate">Privat zus√§tzlich anzeigen</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 border-0 overflow-hidden">
            <div id="vis-wrapper"><div id="visualization"></div></div>
        </div>

        <details open class="bg-white rounded shadow-sm p-3 border">
            <summary class="text-muted fw-bold" style="cursor: pointer;">üìã ROHDATEN ANZEIGEN</summary>
            <div class="table-responsive mt-3">
                <table class="table table-sm table-hover align-middle">
                    <thead class="table-light">
                        <tr><th>Datum</th><th>Titel</th><th>Kategorie</th><th>Sichtbarkeit</th></tr>
                    </thead>
                    <tbody id="timelineBody"></tbody>
                </table>
            </div>
        </details>
    </div>

    <div class="modal fade" id="personModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><form id="personForm"><div class="modal-header"><h5>Person</h5></div><div class="modal-body"><input type="text" id="pName" class="form-control mb-2" placeholder="Name" required><input type="date" id="pBirth" class="form-control"></div><div class="modal-footer"><button type="submit" class="btn btn-primary w-100">Speichern</button></div></form></div></div></div>
    <div class="modal fade" id="eventModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="eventForm"><div class="modal-header"><h5>Ereignis</h5></div><div class="modal-body row g-3"><div class="col-12"><input type="text" id="eTitle" class="form-control" placeholder="Titel" required></div><div class="col-md-6"><select id="eCat" class="form-select"></select></div><div class="col-md-6 pt-2"><input type="checkbox" id="eMilestone"> Meilenstein</div><div class="col-md-6"><input type="date" id="eStart" class="form-control"></div><div class="col-md-6"><input type="date" id="eEnd" class="form-control"></div><div class="col-12"><input type="checkbox" id="ePublic" checked> √ñffentlich</div></div><div class="modal-footer"><button type="submit" class="btn btn-primary w-100">Speichern</button></div></form></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>

    <script>
        let timeline = null;
        let cachedData = [];

        async function init() {
            await loadDropdowns();
            await loadTimeline();
        }

        async function loadDropdowns() {
            const res = await fetch('/categories/');
            const cats = await res.json();
            const eCat = document.getElementById('eCat');
            const fCat = document.getElementById('filterCategory');
            eCat.innerHTML = '<option value="">W√§hle...</option>';
            fCat.innerHTML = '<option value="all">Alle Kategorien</option>';
            cats.forEach(c => {
                const opt = `<option value="${c.id}">${c.name}</option>`;
                eCat.innerHTML += opt; fCat.innerHTML += opt;
            });
        }

        async function loadTimeline() {
            const res = await fetch('/timeline/full');
            cachedData = await res.json();
            applyFilters();
        }

        function applyFilters() {
            const catF = document.getElementById('filterCategory').value;
            const privF = document.getElementById('filterPrivate').checked;

            const filtered = cachedData.filter(i => {
                const matchesCat = (catF === 'all') || (String(i.category_id) === String(catF));
                const matchesPrivacy = (Number(i.is_public) === 1) || privF;
                return matchesCat && matchesPrivacy && i.start_date != null;
            });

            renderTable(filtered);
            renderGraphic(filtered);
        }

        function renderTable(data) {
            const body = document.getElementById('timelineBody');
            body.innerHTML = '';
            data.forEach(i => {
                body.innerHTML += `<tr>
                    <td>${i.start_date}</td>
                    <td><strong>${i.title}</strong></td>
                    <td><span class="badge border text-dark" style="background-color: ${i.color_code + '44'}">${i.category_name}</span></td>
                    <td>${Number(i.is_public) === 1 ? 'üåê' : 'üîí'}</td>
                </tr>`;
            });
        }

        function renderGraphic(data) {
            const wrapper = document.getElementById('vis-wrapper');
            if (timeline) { timeline.destroy(); timeline = null; }
            wrapper.innerHTML = '<div id="visualization"></div>';
            
            const groups = new vis.DataSet([
                {id: 'public', content: '√ñffentlich', value: 1},
                {id: 'private', content: 'Privat', value: 2},
                {id: 'milestones', content: 'Meilensteine', value: 3}
            ]);

            const items = new vis.DataSet(data.map(i => {
                const isM = Number(i.is_milestone) === 1;
                let gId = (Number(i.is_public) === 1) ? 'public' : 'private';
                if (isM) gId = 'milestones';

                // Tooltip als HTML aufbereiten
                const dateInfo = i.end_date ? `${i.start_date} bis ${i.end_date}` : i.start_date;
                const tooltipHtml = `
                    <div style="padding: 5px;">
                        <strong>${i.title}</strong><br>
                        <small>Datum: ${dateInfo}</small>
                        ${i.description ? '<br><span style="color: #666;">' + i.description + '</span>' : ''}
                    </div>
                `;

                return {
                    id: String(i.id),
                    group: gId,
                    content: i.title,
                    title: tooltipHtml,
                    start: i.start_date,
                    end: isM ? null : i.end_date,
                    type: isM ? 'point' : 'range',
                    style: isM 
                        ? `background-color: transparent; border: none; font-weight: bold; color: #333;`
                        : `background-color: ${i.color_code}; border-color: ${i.color_code}; color: #fff;`
                };
            }));

            timeline = new vis.Timeline(document.getElementById('visualization'), items, groups, {
                stack: true, 
                groupOrder: 'value', 
                orientation: 'top', 
                maxHeight: '600px',
                tooltip: { followMouse: true, overflowMethod: 'cap' }
            });
            if (data.length > 0) timeline.fit();
        }

        // Form Handlers (identisch)
        document.getElementById('personForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch('/persons/', { method: 'POST', headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ full_name: document.getElementById('pName').value, birth_date: document.getElementById('pBirth').value || null })
            });
            bootstrap.Modal.getInstance(document.getElementById('personModal')).hide();
            e.target.reset(); loadTimeline();
        };

        document.getElementById('eventForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                title: document.getElementById('eTitle').value,
                category_id: parseInt(document.getElementById('eCat').value),
                start_date: document.getElementById('eStart').value || null,
                end_date: document.getElementById('eEnd').value || null,
                is_milestone: document.getElementById('eMilestone').checked,
                is_public: document.getElementById('ePublic').checked,
                description: "", predecessor_ids: []
            };
            await fetch('/events/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            e.target.reset(); loadTimeline();
        };

        init();
    </script>
</body>
</html>